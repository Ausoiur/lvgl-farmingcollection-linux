# 🌾 智慧大棚监测系统

## 📋 项目介绍

本项目是一个基于 **LVGL（LittlevGL）** 和 **Linux 帧缓冲设备** 开发的**智慧农业终端系统**。该系统专为农业温室/大棚环境监测而设计，通过 ARM Linux 嵌入式平台上运行，提供实时的农业环境参数监测、设备控制和远程数据交互功能。

系统采用 800×480 LCD 触摸屏作为人机交互界面，支持**温度、湿度、CO₂浓度、光照度**等多项环保参数的实时采集与展示，支持**LED灯控制**和**蜂鸣器报警**，并能通过 TCP 协议与服务器进行双向通信。

## 🌟 核心功能

### 📊 环境监测
- **温湿度监测**: 实时显示大棚内温度和湿度数据，支持数据趋势折线图展示
- **CO₂监测**: 实时监测温室内二氧化碳浓度（400-2000 ppm），支持浓度进度条显示
- **光照监测**: 监测温室光照度（0-10000 lux），支持光照数据趋势图表
- **数据采样**: 最近5个数据点的趋势分析，帮助识别环境变化规律

### 💡 设备控制
- **照明系统控制**: 支持 4 路 LED 灯的开关控制，可同时亮灭
- **蜂鸣器报警**: 独立的报警系统，支持远程触发告警
- **实时状态反馈**: 设备状态通过图形化开关显示，支持触摸操作

### 🌐 远程通信
- **TCP 客户端通信**: 实时连接到农业监测服务器（支持自定义IP和端口）
- **双向数据交互**: 每 5 秒自动上传一次环境数据和设备状态
- **远程指令队列**: 支持接收来自服务器的控制指令，支持指令队列机制
- **命令处理**: 异步处理服务器指令，实现远程灯光控制、报警控制等

### 📱 用户界面
- **卡片式布局**: 6 个独立的功能卡片，分别展示不同的监测项
- **中文本地化**: 完全中文界面，采用思源黑体字库
- **实时时钟显示**: 顶部显示当前时间和天气信息
- **滚动资讯**: 农业资讯图片自动轮播（3秒切换一次）
- **响应式设计**: 支持触摸交互，按钮和开关实时反馈

### ⚙️ 硬件接口
- **LED 驱动接口**: 通过 `/dev/Led` 设备文件控制 4 路 LED（ioctl）
- **蜂鸣器接口**: 通过 `/dev/beep` 设备文件控制蜂鸣器（ioctl）
- **触摸屏输入**: 通过 evdev 输入事件处理用户交互
- **帧缓冲显示**: 通过 `/dev/fb0` 直接驱动显示设备

### 🔧 架构特性
- **多线程设计**: 
  - 主线程处理 UI 绘制和刷新
  - 后台刷新线程每 5 秒更新一次数据
  - 接收线程处理服务器通信
- **线程安全**: 采用互斥锁保护共享数据
- **非阻塞 I/O**: 网络通信不阻塞 UI 响应
- **实时性**: LVGL 提供的 5ms 刷新机制确保流畅显示

## 📁 项目结构

```
.
├── main.c                      # LVGL 初始化与主程序
├── Makefile                    # ARM交叉编译配置
├── lv_conf.h                   # LVGL 配置（显示参数、功能选项）
├── lv_drv_conf.h               # 驱动配置（fbdev、evdev 选择）
├── mouse_cursor_icon.c         # 鼠标光标资源
├── demo/                       # 演示程序目录
└── test/                       # 测试和农业应用代码
    ├── nongye.c                ⭐ 【核心】智慧大棚监测系统主程序
    ├── nongye.h                ⭐ 【核心】大棚系统头文件
    ├── chinese_ziku.c          # 中文字库数据（思源黑体）
    ├── lv_font_source_han_sans_bold.h
    ├── nongye.h
    └── ...
├── lvgl/                       # LVGL 库核心代码
    ├── src/                    # LVGL 源代码
    ├── demos/                  # LVGL 官方演示程序
    ├── examples/               # LVGL 使用示例
    └── docs/                   # 官方文档
└── lv_drivers/                 # LVGL 驱动库
    ├── display/fbdev.c         # 帧缓冲显示驱动
    ├── display/fbdev.h
    ├── indev/evdev.c           # 输入事件驱动（触摸/鼠标/键盘）
    ├── indev/evdev.h
    ├── display/                # 其他显示驱动（DRM、LCD 驱动等）
    └── indev/                  # 其他输入驱动（AD 触摸、XPT2046 等）
```

### 关键文件说明

| 文件 | 说明 |
|------|------|
| **nongye.c** | 智慧大棚监测系统的核心实现，包含UI创建、数据采集、设备控制、网络通信等 |
| **nongye.h** | 大棚系统的接口定义，提供 `nongye_ui_create()` 和 `nongye_ui_refresh()` 两个关键函数 |
| **main.c** | LVGL 框架初始化、显示驱动/输入驱动注册、调用农业应用的入口 |
| **lv_conf.h** | LVGL 配置文件，定义分辨率(800×480)、颜色深度等参数 |
| **lv_drv_conf.h** | 驱动配置文件，启用 fbdev 和 evdev 驱动 |

## 🚀 快速开始

### 前置要求

- **硬件环境**:
  - ARM Linux 嵌入式平台（GEC6818、AM335x、RK3399 等）
  - 800×480 LCD 显示屏（连接到帧缓冲设备 `/dev/fb0`）
  - 触摸屏或输入设备（连接到 `/dev/input/eventX`）
  - LED 驱动设备 `/dev/Led`（4路LED控制）
  - 蜂鸣器设备 `/dev/beep`（报警用）
  - 以太网接口（用于连接监测服务器）

- **软件环境**:
  - ARM Linux 交叉编译工具链（如 `arm-linux-gcc`）
  - Linux 开发环境


### 总体架构

```
┌─────────────────────────────────────────────┐
│        智慧大棚监测系统 (nongye.c)            │
├─────────────────────────────────────────────┤
│  ┌──────────────┐      ┌──────────────────┐ │
│  │   UI 线程    │      │  后台数据线程      │ │
│  │ (主线程)     │      │ (refresh_thread)  │ │
│  │              │◄────►│                  │ │
│  │ 显示更新     │      │ 数据采集/上报      │ │
│  │ 触摸响应     │      │ TCP 发送          │ │
│  └──────────────┘      └──────────────────┘ │
│         ▲                      ▲            │
│         │                      │            │
│         └──────────┬───────────┘            │
│                    │                        │
│         ┌──────────▼──────────┐             │
│         │ 接收线程            │              │
│         │ (recv_thread)       │             │
│         │ TCP 接收            │             │
│         │ 远程指令处理        │              │
│         └─────────────────────┘             │
└─────────────────────────────────────────────┘
         ▲                    ▲
         │                    │
    ┌────┴───┐           ┌────┴───┐
    │  LVGL  │           │ Linux  │
    │  库    │           │  驱动   |
    ├────────┤           ├────────┤
    │fbdev   │           │ /dev/  │
    │evdev   │           │ fb0    │
    └────────┘           │ input  │
                         │ Led    │
                         │ beep   │
                         └────────┘
```
